<!DOCTYPE html>
<html lang="zh-CN" class="precheck-hide">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我的邮箱 - iDing's临时邮箱</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/mailbox.css" />
  <script src="/js/auth-guard.js" defer></script>
  <script>
    // 简单的鉴权逻辑保留
    (function(){
      // 恢复主题设置
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);

      fetch('/api/session', { headers: { 'Cache-Control': 'no-cache' } })
        .then(r => r.ok ? r.json() : Promise.reject('unauth'))
        .then(s => {
          if (s && s.role === 'mailbox'){
            try{ document.documentElement.classList.remove('precheck-hide'); }catch(_){ }
          } else {
            location.replace('/');
          }
        })
        .catch(() => {
           if (window.AuthGuard) { window.AuthGuard.goLoading('/html/mailbox.html', '正在校验权限…'); }
           else { location.replace('/templates/loading.html?redirect=%2Fhtml%2Fmailbox.html&status=' + encodeURIComponent('正在校验权限…')); }
        });
    })();
  </script>
</head>
<body>

<!-- 顶部导航 -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <span class="brand-icon">📧</span>
      <span class="brand-text">iDing's</span>
    </div>
    
    <div class="nav-actions">
      <button id="theme-toggle" class="theme-toggle" title="切换主题">
        <span class="icon-moon">🌙</span>
        <span class="icon-sun hidden">☀️</span>
      </button>
      <button id="logout" class="btn btn-secondary btn-sm" title="退出登录">
        <span class="btn-icon">🚪</span>
        <span class="btn-text">退出</span>
      </button>
    </div>
  </div>
  <div id="auto-refresh-bar" class="refresh-progress-bar"></div>
</div>

<div class="toast" id="toast"></div>

<!-- 主界面 -->
<div class="mailbox-container">
  
  <!-- 顶部 ID Card -->
  <div class="mailbox-header-section">
    <div class="mailbox-id-card">
      <div class="id-card-info">
        <span class="id-card-label">TEMPORARY EMAIL ID</span>
        <div class="id-card-address">
          <span id="current-mailbox">loading...</span>
        </div>
        <div class="id-card-label" style="opacity: 0.6; font-size: 10px; margin-top: 4px;">VALID SESSION • SECURE • ENCRYPTED</div>
      </div>
      <div class="id-card-actions">
        <button id="copy-mailbox" class="btn-glass">
          <span>📋</span> 复制地址
        </button>
        <button id="change-password" class="btn-glass">
          <span>🔒</span> 密码
        </button>
      </div>
    </div>
  </div>

  <!-- 工具栏 -->
  <div class="mailbox-toolbar">
    <div class="toolbar-group">
      <input id="search-box" class="input input-sm" placeholder="🔍 搜索邮件..." style="width: 200px;">
      <span class="chip chip-unread" id="unread-badge" style="display:none;">未读 <span id="unread-count">0</span></span>
    </div>
    <div class="toolbar-group">
      <label class="toggle" title="自动刷新">
        <input id="auto-refresh" type="checkbox" checked />
        <span>自动接收</span>
      </label>
      <button id="refresh-emails" class="btn btn-ghost btn-sm">
        <span>🔄</span> 刷新
      </button>
    </div>
  </div>

  <!-- 双栏视图 -->
  <div class="mailbox-split-view">
    
    <!-- 左侧：邮件列表 -->
    <div class="email-list-pane">
      <div class="email-list-header">
        <span class="email-list-title">收件箱</span>
        <span class="text-sm text-muted" id="total-count">0 封邮件</span>
      </div>
      
      <div id="email-list-container" class="email-list-scroll">
        <!-- 列表加载中 -->
        <div id="list-loading" class="state-loading" style="display:flex; padding: 20px;">
          <div class="spinner"></div>
          <p class="text-sm text-muted">正在获取邮件...</p>
        </div>
        
        <!-- 空状态 -->
        <div id="list-empty" class="state-empty" style="display:none; padding: 40px 20px;">
          <div style="font-size: 48px; margin-bottom: 10px;">📭</div>
          <p class="text-muted">暂无邮件</p>
          <p class="text-xs text-muted">等待信鸽到达...</p>
        </div>

        <!-- 列表内容 (JS渲染) -->
        <div id="email-list"></div>
      </div>
    </div>

    <!-- 右侧：邮件详情 -->
    <div class="email-detail-pane">
      
      <!-- 详情页空状态 (未选择邮件) -->
      <div id="detail-empty" class="email-content-empty">
        <div class="empty-illustration">
          <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="100" cy="100" r="80" fill="var(--primary-light)"/>
            <path d="M60 80L100 110L140 80" stroke="var(--primary)" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="50" y="60" width="100" height="80" rx="8" stroke="var(--primary)" stroke-width="8"/>
          </svg>
        </div>
        <h3>选择一封邮件查看</h3>
        <p>点击左侧列表中的邮件以查看详细内容</p>
      </div>

      <!-- 详情页内容 -->
      <div id="detail-content" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="email-detail-header">
          <h1 id="detail-subject" class="detail-subject">无主题</h1>
          <div class="detail-meta">
            <div id="detail-avatar" class="email-avatar">?</div>
            <div class="detail-sender-info">
              <div id="detail-from" class="detail-from">发件人</div>
              <div id="detail-date" class="detail-time">时间</div>
            </div>
          </div>
        </div>
        <div id="detail-body" class="email-detail-body">
          <!-- iframe or html content -->
        </div>
      </div>

    </div>

  </div>

</div>

<!-- 移动端详情模态框 (仅在移动端使用) -->
<div id="email-modal" class="modal">
  <div class="modal-content" style="height: 90vh; display: flex; flex-direction: column; padding: 0;">
    <div class="modal-header" style="padding: 16px;">
      <h3 class="modal-title">邮件详情</h3>
      <button id="modal-close" class="btn-close">×</button>
    </div>
    <div class="modal-body" style="flex: 1; overflow: hidden; padding: 0;">
      <!-- 复用详情结构，通过JS克隆或重新渲染 -->
      <div id="modal-detail-container" style="height: 100%; overflow-y: auto; padding: 16px;">
        <!-- Content will be injected here -->
      </div>
    </div>
  </div>
</div>

<!-- 密码修改模态框 -->
<div id="password-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">修改密码</h3>
      <button id="password-close" class="btn-close">×</button>
    </div>
    <div class="modal-body">
      <form id="password-form">
        <div class="form-group">
          <label>当前密码</label>
          <input type="password" id="current-password" class="input" required>
        </div>
        <div class="form-group">
          <label>新密码</label>
          <input type="password" id="new-password" class="input" required minlength="6">
        </div>
        <div class="form-group">
          <label>确认新密码</label>
          <input type="password" id="confirm-password" class="input" required minlength="6">
        </div>
        <div class="modal-actions">
          <button type="button" id="password-cancel" class="btn btn-ghost">取消</button>
          <button type="submit" id="password-submit" class="btn btn-primary">确认修改</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="/js/toast-utils.js"></script>
<script src="/js/mailbox.js"></script>
</body>
</html>
